<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tetris - Classic</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            margin: 0;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #0a0a0a 100%);
            font-family: "Segoe UI", sans-serif;
            color: white;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        .centered { display: flex; flex-direction: column; align-items: center; justify-content: center; animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        #playerStats { position: absolute; top: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 10; }
        #coinsDisplay { padding: 12px 25px; background: rgba(255, 215, 0, 0.1); border: 3px solid gold; border-radius: 12px; font-size: 24px; color: gold; text-shadow: 0 0 15px gold; }
        #levelDisplay { padding: 12px 25px; background: rgba(138, 43, 226, 0.1); border: 3px solid #9370db; border-radius: 12px; font-size: 24px; color: #da70d6; }
        
        .xp-bar-container { width: 100%; height: 8px; background: rgba(0, 0, 0, 0.5); border-radius: 4px; margin-top: 8px; }
        .xp-bar { height: 100%; background: linear-gradient(90deg, #9370db, #da70d6); width: 0%; transition: width 0.3s; }

        #tetrisGame { display: flex; position: relative; gap: 30px; }
        .game-container { display: flex; gap: 30px; align-items: flex-start; }
        .info-box { background: rgba(30, 30, 60, 0.7); border: 2px solid #00ffff; border-radius: 12px; padding: 20px; min-width: 150px; text-align: center; }
        #tetris { display: grid; background: rgba(17, 17, 34, 0.9); border: 3px solid #00ffff; border-radius: 8px; box-shadow: 0 0 40px rgba(0, 255, 255, 0.5); }
        .cell { width: 30px; height: 30px; border: 1px solid rgba(255,255,255,0.05); }
        
        #nextPiece { width: 120px; height: 120px; display: grid; grid-template-columns: repeat(4, 30px); grid-template-rows: repeat(4, 30px); margin: 10px auto; background: #111; }
        .preview-cell { width: 30px; height: 30px; }

        #nameModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: #1a1a2e; padding: 40px; border-radius: 20px; border: 2px solid #00ffff; text-align: center; }
        .menuBtn { padding: 15px 30px; font-size: 20px; cursor: pointer; background: #00ffff; border: none; color: #000; font-weight: bold; border-radius: 10px; margin-top: 20px; }
        
        .pause-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; font-size: 50px; color: #00ffff; }
    </style>
</head>
<body>

<div id="playerStats">
    <div id="levelDisplay">
        ‚≠ê Level <span id="playerLevel">1</span>
        <div class="xp-bar-container"><div class="xp-bar" id="xpBar"></div></div>
        <div style="font-size: 12px;" id="xpText">0 / 50 XP</div>
    </div>
    <div id="coinsDisplay">üí∞ <span id="coinCount">0</span></div>
</div>

<div id="tetrisGame" class="centered">
    <div class="game-container">
        <div class="side-panel">
            <div class="info-box">
                <h3>DAL≈†√ç</h3>
                <div id="nextPiece"></div>
            </div>
        </div>
        <div id="tetris"></div>
        <div class="side-panel">
            <div class="info-box">
                <h3>SK√ìRE</h3>
                <div id="score">0</div>
            </div>
        </div>
    </div>
</div>

<div id="pauseOverlay" class="pause-overlay">PAUZA</div>

<div id="nameModal">
    <div class="modal-content">
        <h2>üéâ KONEC HRY üéâ</h2>
        <p>Sk√≥re: <span id="finalScore">0</span></p>
        <div style="color: gold; font-size: 24px; margin: 10px;">üí∞ +<span id="earnedCoins">0</span></div>
        <div style="color: #da70d6;">‚≠ê +<span id="earnedXP">0</span> XP</div>
        <button class="menuBtn" onclick="location.reload()">Hr√°t znovu</button>
    </div>
</div>

<script>
    // Glob√°ln√≠ stav (p≈ô√≠stupn√Ω i pro moduly)
    window.gameState = {
        score: 0,
        level: 1,
        playerLevel: 1,
        playerXP: 0,
        playerCoins: 0,
        isPaused: false,
        isGameOver: false,
        dropInterval: 500,
        mapRows: 20,
        mapCols: 10,
        currentTheme: 'classic'
    };

    const xpRequirements = [0, 50, 150, 300, 500, 750, 1050, 1400, 1800, 2250];

    function updateLevelUI() {
        document.getElementById('playerLevel').textContent = window.gameState.playerLevel;
        document.getElementById('coinCount').textContent = window.gameState.playerCoins;
        
        const lvl = window.gameState.playerLevel;
        const xp = window.gameState.playerXP;
        const currentReq = xpRequirements[lvl - 1];
        const nextReq = xpRequirements[lvl] || xp;
        const progress = ((xp - currentReq) / (nextReq - currentReq)) * 100;
        
        document.getElementById('xpBar').style.width = Math.min(100, progress) + '%';
        document.getElementById('xpText').textContent = `${xp - currentReq} / ${nextReq - currentReq} XP`;
    }
</script>

<script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.3'

    const SUPABASE_URL = 'https://bmmaijlbpwgzhrxzxphf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJtbWFpamxicHdnemhyeHp4cGhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NjQ5MDcsImV4cCI6MjA4MjQ0MDkwN30.s0YQVnAjMXFu1pSI1NXZ2naSab179N0vQPglsmy3Pgw';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Tetris Logika
    const tetrisEl = document.getElementById('tetris');
    const shapes = [
        {shape: [[1,1,1,1]], color: '#00ffff'}, // I
        {shape: [[1,1],[1,1]], color: '#ffff00'}, // O
        {shape: [[0,1,0],[1,1,1]], color: '#ff00ff'}, // T
        {shape: [[0,1,1],[1,1,0]], color: '#00ff00'}, // S
        {shape: [[1,1,0],[0,1,1]], color: '#ff0000'}, // Z
        {shape: [[1,0,0],[1,1,1]], color: '#0000ff'}, // J
        {shape: [[0,0,1],[1,1,1]], color: '#ff8000'}  // L
    ];

    let grid = [];
    let currentPiece = null;
    let nextPiece = null;
    let gameTimer = null;

    function init() {
        grid = Array(window.gameState.mapRows).fill().map(() => Array(window.gameState.mapCols).fill(0));
        tetrisEl.style.gridTemplateColumns = `repeat(${window.gameState.mapCols}, 30px)`;
        
        for(let i=0; i < window.gameState.mapRows * window.gameState.mapCols; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            tetrisEl.appendChild(cell);
        }
        
        nextPiece = getRandomPiece();
        spawnPiece();
        updateLevelUI();
        gameLoop();
    }

    function getRandomPiece() {
        const piece = shapes[Math.floor(Math.random() * shapes.length)];
        return { ...piece, x: Math.floor(window.gameState.mapCols/2) - 1, y: 0 };
    }

    function spawnPiece() {
        currentPiece = nextPiece;
        nextPiece = getRandomPiece();
        drawPreview();
        if (checkCollision(0, 0)) {
            gameOver();
        }
    }

    function checkCollision(dx, dy, newShape = currentPiece.shape) {
        for (let y = 0; y < newShape.length; y++) {
            for (let x = 0; x < newShape[y].length; x++) {
                if (newShape[y][x]) {
                    let nx = currentPiece.x + x + dx;
                    let ny = currentPiece.y + y + dy;
                    if (nx < 0 || nx >= window.gameState.mapCols || ny >= window.gameState.mapRows || (ny >= 0 && grid[ny][nx])) {
                        return true;
                    }
                }
            }
        }
        return false;
    }

    function rotate() {
        const r = currentPiece.shape[0].map((_, i) => currentPiece.shape.map(row => row[i]).reverse());
        if (!checkCollision(0, 0, r)) currentPiece.shape = r;
        draw();
    }

    function move(dx, dy) {
        if (!checkCollision(dx, dy)) {
            currentPiece.x += dx;
            currentPiece.y += dy;
            draw();
            return true;
        }
        if (dy > 0) {
            lockPiece();
            spawnPiece();
        }
        return false;
    }

    function lockPiece() {
        currentPiece.shape.forEach((row, y) => {
            row.forEach((value, x) => {
                if (value) {
                    const ny = currentPiece.y + y;
                    if (ny >= 0) grid[ny][currentPiece.x + x] = currentPiece.color;
                }
            });
        });
        clearLines();
    }

    function clearLines() {
        let lines = 0;
        for (let y = window.gameState.mapRows - 1; y >= 0; y--) {
            if (grid[y].every(cell => cell !== 0)) {
                grid.splice(y, 1);
                grid.unshift(Array(window.gameState.mapCols).fill(0));
                lines++;
                y++;
            }
        }
        if (lines > 0) {
            window.gameState.score += lines * 100;
            document.getElementById('score').textContent = window.gameState.score;
        }
    }

    function draw() {
        const cells = tetrisEl.getElementsByClassName('cell');
        // Reset
        for (let i = 0; i < cells.length; i++) {
            cells[i].style.backgroundColor = '';
            cells[i].style.boxShadow = '';
        }
        // Grid
        grid.forEach((row, y) => {
            row.forEach((color, x) => {
                if (color) {
                    const idx = y * window.gameState.mapCols + x;
                    cells[idx].style.backgroundColor = color;
                }
            });
        });
        // Current
        currentPiece.shape.forEach((row, y) => {
            row.forEach((value, x) => {
                if (value) {
                    const nx = currentPiece.x + x;
                    const ny = currentPiece.y + y;
                    if (ny >= 0) {
                        const idx = ny * window.gameState.mapCols + nx;
                        cells[idx].style.backgroundColor = currentPiece.color;
                        cells[idx].style.boxShadow = `inset 0 0 10px white`;
                    }
                }
            });
        });
    }

    function drawPreview() {
        const nextEl = document.getElementById('nextPiece');
        nextEl.innerHTML = '';
        for(let i=0; i<16; i++) nextEl.appendChild(document.createElement('div'));
        
        nextPiece.shape.forEach((row, y) => {
            row.forEach((val, x) => {
                if(val) {
                    const idx = y * 4 + x;
                    nextEl.children[idx].style.backgroundColor = nextPiece.color;
                    nextEl.children[idx].className = 'preview-cell';
                }
            });
        });
    }

    function gameLoop() {
        if (!window.gameState.isPaused && !window.gameState.isGameOver) {
            move(0, 1);
        }
        gameTimer = setTimeout(gameLoop, window.gameState.dropInterval);
    }

    async function gameOver() {
        window.gameState.isGameOver = true;
        clearTimeout(gameTimer);
        
        const earnedCoins = Math.floor(window.gameState.score / 10);
        const earnedXP = Math.floor(window.gameState.score / 5);
        
        document.getElementById('finalScore').textContent = window.gameState.score;
        document.getElementById('earnedCoins').textContent = earnedCoins;
        document.getElementById('earnedXP').textContent = earnedXP;
        document.getElementById('nameModal').style.display = 'flex';

        // Tady by ≈°lo vol√°n√≠ Supabase pro ulo≈æen√≠
        console.log("Game Over. Saving stats...");
    }

    // Input
    window.addEventListener('keydown', e => {
        if (window.gameState.isGameOver) return;
        if (e.key === 'p') {
            window.gameState.isPaused = !window.gameState.isPaused;
            document.getElementById('pauseOverlay').style.display = window.gameState.isPaused ? 'flex' : 'none';
        }
        if (window.gameState.isPaused) return;
        
        if (e.key === 'ArrowLeft') move(-1, 0);
        if (e.key === 'ArrowRight') move(1, 0);
        if (e.key === 'ArrowDown') move(0, 1);
        if (e.key === 'ArrowUp') rotate();
        if (e.key === ' ') { while(move(0,1)); }
    });

    init();
</script>

</body>
</html>

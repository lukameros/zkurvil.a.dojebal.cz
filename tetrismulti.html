<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tetris Multiplayer</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    margin: 0;
    background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #0a0a0a 100%);
    font-family: "Segoe UI", sans-serif;
    color: white;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow-x: hidden;
}

.centered {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
}

h1 {
    margin-bottom: 30px;
    font-size: 56px;
    text-align: center;
    text-shadow: 0 0 20px #ff00ff, 0 0 40px #ff00ff;
    animation: glow 2s ease-in-out infinite;
}

@keyframes glow {
    0%, 100% { text-shadow: 0 0 20px #ff00ff, 0 0 40px #ff00ff; }
    50% { text-shadow: 0 0 30px #00ffff, 0 0 60px #00ffff; }
}

#backBtn {
    position: absolute;
    top: 20px;
    left: 20px;
    padding: 12px 24px;
    border-radius: 8px;
    border: 2px solid #ff00ff;
    background: rgba(180, 0, 180, 0.3);
    color: white;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 0 15px rgba(255, 0, 255, 0.5);
    z-index: 10;
    transition: all 0.3s;
}

#backBtn:hover {
    background: rgba(255, 0, 255, 0.5);
    box-shadow: 0 0 25px rgba(255, 0, 255, 0.8);
    transform: translateY(-2px);
}

button.menuBtn {
    padding: 16px 48px;
    margin: 12px 0;
    font-size: 22px;
    border: 2px solid #00ffff;
    border-radius: 12px;
    cursor: pointer;
    font-weight: bold;
    background: linear-gradient(135deg, rgba(0, 100, 200, 0.4), rgba(100, 0, 200, 0.4));
    color: white;
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
    transition: all 0.3s;
    min-width: 280px;
}

button.menuBtn:hover {
    transform: scale(1.08) translateY(-3px);
    box-shadow: 0 0 35px rgba(0, 255, 255, 0.8);
    background: linear-gradient(135deg, rgba(0, 150, 255, 0.6), rgba(150, 0, 255, 0.6));
}

.info-box {
    background: rgba(30, 30, 60, 0.7);
    border: 2px solid #00ffff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
    min-width: 180px;
}

.info-box h3 {
    text-align: center;
    margin-bottom: 15px;
    color: #00ffff;
    text-shadow: 0 0 10px #00ffff;
}

.score-display {
    font-size: 32px;
    font-weight: bold;
    text-align: center;
    color: #fff;
    text-shadow: 0 0 10px #ff00ff;
}

.cell {
    width: 25px;
    height: 25px;
    background: #1a1a2e;
    border: 1px solid #111;
    border-radius: 3px;
    transition: all 0.1s;
}

.cell.filled {
    box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.3);
}

#gameCodeDisplay {
    background: rgba(0,255,255,0.1);
    border: 3px solid #0ff;
    border-radius: 12px;
    padding: 30px;
    margin: 20px 0;
    text-align: center;
}

#gameCodeDisplay h2 {
    color: #0ff;
    font-size: 48px;
    margin-bottom: 20px;
}

#gameCodeText {
    font-size: 72px;
    font-weight: 900;
    color: #fff;
    text-shadow: 0 0 30px #0ff;
    letter-spacing: 10px;
}

#gameInput {
    padding: 15px;
    font-size: 18px;
    margin: 20px 0;
    width: 300px;
    text-align: center;
    text-transform: uppercase;
    background: rgba(0,0,0,0.5);
    color: #fff;
    border: 2px solid #0ff;
    border-radius: 8px;
}

#gameInput:focus {
    outline: none;
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
}

.loading {
    text-align: center;
    padding: 20px;
    font-size: 18px;
    color: #00ffff;
}

.game-arena {
    display: flex;
    gap: 40px;
    justify-content: center;
    align-items: flex-start;
    margin-top: 30px;
}

.player-section {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.player-name {
    font-size: 32px;
    font-weight: 900;
    margin-bottom: 20px;
    text-shadow: 0 0 20px currentColor;
}

.player-stats {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}

.tetris-grid {
    display: grid;
    gap: 1px;
    background: rgba(17, 17, 34, 0.9);
    border: 3px solid;
    border-radius: 8px;
    box-shadow: 0 0 40px;
    padding: 3px;
}

.status-text {
    font-size: 20px;
    font-weight: 900;
    margin-top: 15px;
    text-align: center;
}

.winner-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 100;
}

.winner-content {
    background: linear-gradient(135deg, #1a1a2e, #2a2a4e);
    padding: 60px;
    border-radius: 16px;
    border: 3px solid gold;
    box-shadow: 0 0 50px gold;
    text-align: center;
}

.winner-content h1 {
    font-size: 64px;
    color: gold;
    text-shadow: 0 0 30px gold;
    margin-bottom: 30px;
}

.controls {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(30, 30, 60, 0.8);
    border: 2px solid #00ffff;
    border-radius: 8px;
    padding: 15px;
    font-size: 14px;
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
}

.controls h4 {
    color: #00ffff;
    margin-bottom: 8px;
}

.controls div {
    margin: 4px 0;
}

@media (max-width: 1200px) {
    .game-arena {
        flex-direction: column;
        gap: 20px;
    }
}
</style>
</head>
<body>

<button id="backBtn" onclick="leaveGame()">‚¨Ö Zpƒõt</button>

<!-- Menu -->
<div id="mainMenu" class="centered">
    <h1>üåê TETRIS MULTIPLAYER üåê</h1>
    <button class="menuBtn" onclick="createGame()">üéÆ Vytvo≈ôit hru</button>
    <button class="menuBtn" onclick="showJoinMenu()">üîó P≈ôipojit se ke h≈ôe</button>
</div>

<!-- Join Menu -->
<div id="joinMenu" class="centered" style="display:none;">
    <h1>üîó P≈ôipojit se ke h≈ôe</h1>
    <input id="gameInput" placeholder="Zadej k√≥d hry (nap≈ô. ABC123)" maxlength="6">
    <button class="menuBtn" onclick="joinGame()">‚úÖ P≈ôipojit se</button>
    <button class="menuBtn" onclick="backToMenu()">‚¨Ö Zpƒõt</button>
</div>

<!-- Waiting Room -->
<div id="waitingRoom" class="centered" style="display:none;">
    <h1>‚è≥ ƒåek√°rna</h1>
    <div id="gameCodeDisplay">
        <h2>K√ìD HRY</h2>
        <div id="gameCodeText">------</div>
    </div>
    <p class="loading">‚è≥ ƒåek√° se na druh√©ho hr√°ƒçe...</p>
    <button class="menuBtn" onclick="cancelGame()">‚ùå Zru≈°it</button>
</div>

<!-- Game Arena -->
<div id="gameArena" style="display:none;">
    <div style="text-align: center; margin-bottom: 20px;">
        <h1>üåê ONLINE MULTIPLAYER</h1>
        <p style="font-size: 24px; color: #0ff;">K√≥d hry: <span id="currentGameCode">------</span></p>
    </div>
    
    <div class="game-arena">
        <!-- Hr√°ƒç 1 -->
        <div class="player-section">
            <div class="player-name" id="player1Name" style="color: #00ffff;">üéÆ HR√Åƒå 1</div>
            <div class="player-stats">
                <div class="info-box">
                    <h3>SK√ìRE</h3>
                    <div class="score-display" id="score1">0</div>
                </div>
                <div class="info-box">
                    <h3>√öROVE≈á</h3>
                    <div class="score-display" id="level1">1</div>
                </div>
            </div>
            <div id="grid1" class="tetris-grid" style="border-color: #00ffff; box-shadow: 0 0 40px rgba(0,255,255,0.5);"></div>
            <p class="status-text" id="status1" style="color: #0f0;">‚úÖ HRAJE</p>
        </div>
        
        <!-- Hr√°ƒç 2 -->
        <div class="player-section">
            <div class="player-name" id="player2Name" style="color: #ff00ff;">üéÆ HR√Åƒå 2</div>
            <div class="player-stats">
                <div class="info-box">
                    <h3>SK√ìRE</h3>
                    <div class="score-display" id="score2">0</div>
                </div>
                <div class="info-box">
                    <h3>√öROVE≈á</h3>
                    <div class="score-display" id="level2">1</div>
                </div>
            </div>
            <div id="grid2" class="tetris-grid" style="border-color: #ff00ff; box-shadow: 0 0 40px rgba(255,0,255,0.5);"></div>
            <p class="status-text" id="status2" style="color: #0f0;">‚úÖ HRAJE</p>
        </div>
    </div>
    
    <button class="menuBtn" onclick="leaveGame()" style="margin-top: 30px;">üö™ Zpƒõt do menu</button>
</div>

<!-- Winner Overlay -->
<div id="winnerOverlay" class="winner-overlay">
    <div class="winner-content">
        <h1>üèÜ V√çTƒöZ üèÜ</h1>
        <p id="winnerText" style="font-size: 48px; color: #fff; margin-bottom: 30px;">-</p>
        <button class="menuBtn" onclick="backToMenu()">üè† Zpƒõt do menu</button>
    </div>
</div>

<div class="controls">
    <h4>OVL√ÅD√ÅN√ç:</h4>
    <div>‚¨ÖÔ∏è‚û°Ô∏è - Pohyb</div>
    <div>‚¨ÜÔ∏è - Rotace</div>
    <div>‚¨áÔ∏è - Rychlej≈°√≠ p√°d</div>
    <div>MEZERN√çK - Okam≈æit√© um√≠stƒõn√≠</div>
</div>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.3'

const SUPABASE_URL = 'https://bmmaijlbpwgzhrxzxphf.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJtbWFpamxicHdnemhyeHp4cGhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NjQ5MDcsImV4cCI6MjA4MjQ0MDkwN30.s0YQVnAjMXFu1pSI1NXZ2naSab179N0vQPglsmy3Pgw'

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

// Glob√°ln√≠ promƒõnn√©
let currentUser = null
let currentGameId = null
let currentGameCode = null
let myPlayerNumber = null
let gameActive = false
let player1 = null
let player2 = null
let gameStateChannel = null

// Tetris shapes
const shapes = [
    {shape: [[1,1,1,1]], color: 'cyan'},
    {shape: [[1,1],[1,1]], color: 'yellow'},
    {shape: [[0,1,0],[1,1,1]], color: 'purple'},
    {shape: [[0,1,1],[1,1,0]], color: 'green'},
    {shape: [[1,1,0],[0,1,1]], color: 'red'},
    {shape: [[1,0,0],[1,1,1]], color: 'blue'},
    {shape: [[0,0,1],[1,1,1]], color: 'orange'}
]

const colors = {
    cyan: '#00ffff',
    yellow: '#ffff00',
    purple: '#ff00ff',
    green: '#00ff00',
    red: '#ff0000',
    blue: '#0000ff',
    orange: '#ff8800'
}

// Naƒçten√≠ u≈æivatele
async function loadUser() {
    const saved = localStorage.getItem('currentUser')
    if (saved) {
        try {
            currentUser = JSON.parse(saved)
            console.log('P≈ôihl√°≈°en√Ω u≈æivatel:', currentUser.username)
        } catch (e) {
            currentUser = { username: saved, is_guest: true }
        }
    } else {
        currentUser = { username: 'Host_' + Math.floor(Math.random() * 10000), is_guest: true }
    }
}

// Generov√°n√≠ k√≥du hry
function generateGameCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'
    let code = ''
    for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length))
    }
    return code
}

// Vytvo≈ôen√≠ hry
async function createGame() {
    const gameCode = generateGameCode()
    
    try {
        const { data, error } = await supabase
            .from('tetris_multiplayer_games')
            .insert([{
                game_code: gameCode,
                player1_id: currentUser.id || null,
                player1_username: currentUser.username,
                status: 'waiting'
            }])
            .select()
            .single()
        
        if (error) throw error
        
        currentGameId = data.id
        currentGameCode = gameCode
        myPlayerNumber = 1
        
        document.getElementById('mainMenu').style.display = 'none'
        document.getElementById('waitingRoom').style.display = 'flex'
        document.getElementById('gameCodeText').textContent = gameCode
        
        waitForPlayer2()
        
    } catch (error) {
        console.error('Chyba p≈ôi vytv√°≈ôen√≠ hry:', error)
        alert('Chyba p≈ôi vytv√°≈ôen√≠ hry!')
    }
}

// Zobrazit join menu
function showJoinMenu() {
    document.getElementById('mainMenu').style.display = 'none'
    document.getElementById('joinMenu').style.display = 'flex'
}

// P≈ôipojit se ke h≈ôe
async function joinGame() {
    const code = document.getElementById('gameInput').value.trim().toUpperCase()
    
    if (!code || code.length !== 6) {
        alert('Zadej platn√Ω 6-m√≠stn√Ω k√≥d hry!')
        return
    }
    
    try {
        // Zkontroluj, jestli hra existuje
        const { data: game, error: fetchError } = await supabase
            .from('tetris_multiplayer_games')
            .select('*')
            .eq('game_code', code)
            .eq('status', 'waiting')
            .single()
        
        if (fetchError || !game) {
            alert('Hra s t√≠mto k√≥dem neexistuje nebo ji≈æ byla zah√°jena!')
            return
        }
        
        // P≈ôipoj se jako hr√°ƒç 2
        const { data: updatedGame, error: updateError } = await supabase
            .from('tetris_multiplayer_games')
            .update({
                player2_id: currentUser.id || null,
                player2_username: currentUser.username,
                status: 'playing'
            })
            .eq('id', game.id)
            .select()
            .single()
        
        if (updateError) {
            console.error('Chyba p≈ôi p≈ôipojov√°n√≠:', updateError)
            alert('Chyba p≈ôi p≈ôipojov√°n√≠ ke h≈ôe!')
            return
        }
        
        currentGameId = game.id
        currentGameCode = code
        myPlayerNumber = 2
        
        // P≈ôejdi rovnou do hry
        startGame()
        
    } catch (error) {
        console.error('Chyba p≈ôi p≈ôipojov√°n√≠:', error)
        alert('Chyba p≈ôi p≈ôipojov√°n√≠ ke h≈ôe!')
    }
}

// ƒåek√°n√≠ na druh√©ho hr√°ƒçe
async function waitForPlayer2() {
    console.log('ƒåek√°m na hr√°ƒçe 2, game_id:', currentGameId)
    
    const channel = supabase
        .channel(`game_wait_${currentGameId}`)
        .on('postgres_changes', {
            event: 'UPDATE',
            schema: 'public',
            table: 'tetris_multiplayer_games',
            filter: `id=eq.${currentGameId}`
        }, (payload) => {
            console.log('Zmƒõna v h≈ôe:', payload)
            if (payload.new.status === 'playing') {
                console.log('Hra zaƒç√≠n√°!')
                channel.unsubscribe()
                startGame()
            }
        })
        .subscribe((status) => {
            console.log('Subscription status:', status)
        })
    
    // Z√°lo≈æn√≠ kontrola ka≈æd√Ωch 2 sekundy
    const checkInterval = setInterval(async () => {
        const { data: game } = await supabase
            .from('tetris_multiplayer_games')
            .select('*')
            .eq('id', currentGameId)
            .single()
        
        console.log('Kontrola stavu hry:', game)
        
        if (game && game.status === 'playing') {
            clearInterval(checkInterval)
            channel.unsubscribe()
            startGame()
        }
    }, 2000)
    
    // Ulo≈æ interval ID pro p≈ô√≠padn√© zru≈°en√≠
    window.waitInterval = checkInterval
}

// Zru≈°en√≠ hry
async function cancelGame() {
    // Zastav ƒçekac√≠ interval
    if (window.waitInterval) {
        clearInterval(window.waitInterval)
        window.waitInterval = null
    }
    
    if (currentGameId) {
        await supabase
            .from('tetris_multiplayer_games')
            .delete()
            .eq('id', currentGameId)
    }
    backToMenu()
}

// Zpƒõt do menu
function backToMenu() {
    if (gameStateChannel) {
        gameStateChannel.unsubscribe()
        gameStateChannel = null
    }
    
    gameActive = false
    currentGameId = null
    currentGameCode = null
    myPlayerNumber = null
    
    // Resetuj hr√°ƒçe
    player1 = null
    player2 = null
    
    document.getElementById('mainMenu').style.display = 'flex'
    document.getElementById('joinMenu').style.display = 'none'
    document.getElementById('waitingRoom').style.display = 'none'
    document.getElementById('gameArena').style.display = 'none'
    document.getElementById('winnerOverlay').style.display = 'none'
}

// Start hry
async function startGame() {
    console.log('Spou≈°t√≠m hru pro hr√°ƒçe:', myPlayerNumber)
    
    // Zastav ƒçekac√≠ interval pokud bƒõ≈æ√≠
    if (window.waitInterval) {
        clearInterval(window.waitInterval)
        window.waitInterval = null
    }
    
    document.getElementById('waitingRoom').style.display = 'none'
    document.getElementById('joinMenu').style.display = 'none'
    document.getElementById('gameArena').style.display = 'flex'
    document.getElementById('currentGameCode').textContent = currentGameCode
    
    gameActive = true
    
    // Naƒçti data hry
    const { data: game } = await supabase
        .from('tetris_multiplayer_games')
        .select('*')
        .eq('id', currentGameId)
        .single()
    
    console.log('Data hry:', game)
    
    document.getElementById('player1Name').textContent = `üéÆ ${game.player1_username}`
    document.getElementById('player2Name').textContent = `üéÆ ${game.player2_username}`
    
    // Vytvo≈ô hr√°ƒçe
    player1 = createPlayer('grid1', 'score1', 'level1', 1)
    player2 = createPlayer('grid2', 'score2', 'level2', 2)
    
    // Vytvo≈ô poƒç√°teƒçn√≠ stav
    const myPlayer = myPlayerNumber === 1 ? player1 : player2
    await saveGameState(myPlayer)
    
    // Sleduj zmƒõny
    subscribeToGame()
    
    // Start loop
    gameLoop()
    
    console.log('Hra spu≈°tƒõna!')
}

// Vytvo≈ôen√≠ hr√°ƒçe
function createPlayer(gridId, scoreId, levelId, playerNum) {
    const rows = 20
    const cols = 10
    
    const player = {
        grid: [],
        current: null,
        nextPiece: null,
        score: 0,
        level: 1,
        lines: 0,
        gameOver: false,
        dropInterval: 600,
        lastDrop: Date.now(),
        gridElement: document.getElementById(gridId),
        scoreElement: document.getElementById(scoreId),
        levelElement: document.getElementById(levelId),
        rows: rows,
        cols: cols,
        playerNumber: playerNum
    }
    
    // Vytvo≈ô grid
    player.gridElement.innerHTML = ''
    player.gridElement.style.gridTemplateRows = `repeat(${rows}, 25px)`
    player.gridElement.style.gridTemplateColumns = `repeat(${cols}, 25px)`
    
    for (let r = 0; r < rows; r++) {
        player.grid[r] = []
        for (let c = 0; c < cols; c++) {
            const cell = document.createElement('div')
            cell.classList.add('cell')
            player.gridElement.appendChild(cell)
            player.grid[r][c] = 0
        }
    }
    
    player.nextPiece = randomShape()
    newPiece(player)
    
    return player
}

// N√°hodn√Ω tvar
function randomShape() {
    const shape = shapes[Math.floor(Math.random() * shapes.length)]
    return {
        shape: shape.shape.map(r => r.slice()),
        color: shape.color
    }
}

// Nov√Ω d√≠lek
function newPiece(player) {
    player.current = player.nextPiece
    player.current.x = Math.floor(player.cols / 2) - 1
    player.current.y = 0
    player.nextPiece = randomShape()
    
    if (collision(player)) {
        player.gameOver = true
        // KDO PROHR√ÅL = ten jeho≈æ hra skonƒçila
        // Tak≈æe pokud J√Å jsem prohr√°l (myPlayerNumber), DRUH√ù vyhr√°l
        const winnerNumber = player.playerNumber === 1 ? 2 : 1
        endGame(winnerNumber)
    }
}

// Kolize
function collision(player, offsetX = 0, offsetY = 0) {
    for (let r = 0; r < player.current.shape.length; r++) {
        for (let c = 0; c < player.current.shape[r].length; c++) {
            if (player.current.shape[r][c]) {
                let newY = player.current.y + r + offsetY
                let newX = player.current.x + c + offsetX
                if (newY >= player.rows || newX < 0 || newX >= player.cols) return true
                if (newY >= 0 && player.grid[newY][newX]) return true
            }
        }
    }
    return false
}

// Pohyb dol≈Ø
function moveDown(player) {
    if (player.gameOver) return
    
    player.current.y++
    if (collision(player)) {
        player.current.y--
        freeze(player)
        newPiece(player)
    }
}

// Zmrazen√≠
function freeze(player) {
    for (let r = 0; r < player.current.shape.length; r++) {
        for (let c = 0; c < player.current.shape[r].length; c++) {
            if (player.current.shape[r][c]) {
                player.grid[player.current.y + r][player.current.x + c] = player.current.color
            }
        }
    }
    clearLines(player)
}

// Maz√°n√≠ ≈ô√°dk≈Ø
function clearLines(player) {
    let cleared = 0
    for (let r = player.rows - 1; r >= 0; r--) {
        if (player.grid[r].every(cell => cell !== 0)) {
            player.grid.splice(r, 1)
            player.grid.unshift(Array(player.cols).fill(0))
            cleared++
            r++
        }
    }
    
    if (cleared > 0) {
        player.lines += cleared
        player.score += cleared * 100 * player.level
        player.level = Math.floor(player.lines / 10) + 1
        player.dropInterval = Math.max(100, 600 - (player.level * 50))
        updateDisplay(player)
    }
}

// Vykreslen√≠
function draw(player) {
    const cells = player.gridElement.querySelectorAll('.cell')
    
    cells.forEach(cell => {
        cell.style.background = '#1a1a2e'
        cell.style.boxShadow = 'none'
        cell.classList.remove('filled')
    })
    
    for (let r = 0; r < player.rows; r++) {
        for (let c = 0; c < player.cols; c++) {
            if (player.grid[r][c]) {
                const cell = cells[r * player.cols + c]
                const color = colors[player.grid[r][c]]
                cell.style.background = color
                cell.style.boxShadow = `0 0 8px ${color}`
                cell.classList.add('filled')
            }
        }
    }
    
    if (player.current) {
        for (let r = 0; r < player.current.shape.length; r++) {
            for (let c = 0; c < player.current.shape[r].length; c++) {
                if (player.current.shape[r][c]) {
                    const index = (player.current.y + r) * player.cols + (player.current.x + c)
                    if (index >= 0 && index < cells.length) {
                        const color = colors[player.current.color]
                        cells[index].style.background = color
                        cells[index].style.boxShadow = `0 0 12px ${color}`
                        cells[index].classList.add('filled')
                    }
                }
            }
        }
    }
}

// Aktualizace zobrazen√≠
function updateDisplay(player) {
    player.scoreElement.textContent = player.score
    player.levelElement.textContent = player.level
}

// Rotace
function rotate(player) {
    const shape = player.current.shape
    const N = shape.length
    const M = shape[0].length
    const rotated = []
    
    for (let y = 0; y < M; y++) {
        rotated[y] = []
        for (let x = 0; x < N; x++) {
            rotated[y][x] = shape[N - 1 - x][y] || 0
        }
    }
    
    const oldShape = player.current.shape
    player.current.shape = rotated
    
    if (collision(player)) {
        player.current.shape = oldShape
    }
}

// Hard drop
function hardDrop(player) {
    while (!collision(player, 0, 1)) {
        player.current.y++
    }
    freeze(player)
    newPiece(player)
    player.score += 10
    updateDisplay(player)
}

// Ulo≈æen√≠ stavu
async function saveGameState(player) {
    if (!currentGameId || !player) return
    
    try {
        // Nejd≈ô√≠v zkus smazat star√Ω stav
        await supabase
            .from('tetris_game_state')
            .delete()
            .eq('game_id', currentGameId)
            .eq('player_number', player.playerNumber)
        
        // Potom vlo≈æ nov√Ω
        const { error } = await supabase
            .from('tetris_game_state')
            .insert({
                game_id: currentGameId,
                player_number: player.playerNumber,
                grid: JSON.stringify(player.grid),
                current_piece: JSON.stringify(player.current),
                score: player.score,
                level: player.level,
                lines: player.lines,
                game_over: player.gameOver,
                updated_at: new Date().toISOString()
            })
        
        if (error) {
            console.error('Chyba p≈ôi ukl√°d√°n√≠ stavu:', error)
        }
    } catch (error) {
        console.error('Chyba p≈ôi ukl√°d√°n√≠ stavu:', error)
    }
}

// Sledov√°n√≠ zmƒõn
function subscribeToGame() {
    gameStateChannel = supabase
        .channel(`game_state_${currentGameId}`)
        .on('postgres_changes', {
            event: '*',
            schema: 'public',
            table: 'tetris_game_state',
            filter: `game_id=eq.${currentGameId}`
        }, async (payload) => {
            if (payload.new.player_number !== myPlayerNumber) {
                const otherPlayer = payload.new.player_number === 1 ? player1 : player2
                
                try {
                    otherPlayer.grid = JSON.parse(payload.new.grid)
                    otherPlayer.current = JSON.parse(payload.new.current_piece)
                } catch (e) {
                    otherPlayer.grid = payload.new.grid
                    otherPlayer.current = payload.new.current_piece
                }
                
                otherPlayer.score = payload.new.score
                otherPlayer.level = payload.new.level
                otherPlayer.lines = payload.new.lines
                otherPlayer.gameOver = payload.new.game_over
                
                updateDisplay(otherPlayer)
                draw(otherPlayer)
                
                if (payload.new.game_over) {
                    document.getElementById(`status${payload.new.player_number}`).textContent = '‚ùå PROHR√ÅL'
                    document.getElementById(`status${payload.new.player_number}`).style.color = '#f00'
                }
            }
        })
        .subscribe()
}

// Konec hry
async function endGame(winnerNumber) {
    gameActive = false
    
    const { data: game } = await supabase
        .from('tetris_multiplayer_games')
        .select('*')
        .eq('id', currentGameId)
        .single()
    
    const winner = winnerNumber === 1 ? game.player1_username : game.player2_username
    
    await supabase
        .from('tetris_multiplayer_games')
        .update({
            status: 'finished',
            winner: winner
        })
        .eq('id', currentGameId)
    
    // Zjisti, jestli J√Å jsem vyhr√°l
    const iWon = winnerNumber === myPlayerNumber
    
    document.getElementById('winnerText').textContent = iWon ? 
        `üéâ VYHR√ÅL JSI! üéâ` : 
        `üò¢ ${winner} vyhr√°l! üò¢`
    document.getElementById('winnerOverlay').style.display = 'flex'
}

// Opu≈°tƒõn√≠ hry
async function leaveGame() {
    // Pokud je hra aktivn√≠, oznaƒç ji jako opu≈°tƒõnou
    if (currentGameId) {
        try {
            await supabase
                .from('tetris_multiplayer_games')
                .update({ status: 'finished' })
                .eq('id', currentGameId)
        } catch (e) {
            console.error('Chyba p≈ôi opou≈°tƒõn√≠:', e)
        }
    }
    
    if (gameStateChannel) {
        await gameStateChannel.unsubscribe()
    }
    
    gameActive = false
    
    // P≈ôesmƒõruj na hry.html
    window.location.href = 'hry.html'
}

// Hern√≠ smyƒçka
let lastSaveTime = 0
function gameLoop() {
    if (!gameActive) return
    
    const now = Date.now()
    const myPlayer = myPlayerNumber === 1 ? player1 : player2
    const otherPlayer = myPlayerNumber === 1 ? player2 : player1
    
    if (!myPlayer.gameOver && now - myPlayer.lastDrop > myPlayer.dropInterval) {
        moveDown(myPlayer)
        draw(myPlayer)
        myPlayer.lastDrop = now
        
        // Ukl√°dej stav p≈ôi ka≈æd√©m p√°du kostky
        saveGameState(myPlayer)
        lastSaveTime = now
    }
    
    draw(myPlayer)
    draw(otherPlayer)
    
    requestAnimationFrame(gameLoop)
}

// Ovl√°d√°n√≠
let lastControlSave = 0
document.addEventListener('keydown', e => {
    if (!gameActive) return
    
    const myPlayer = myPlayerNumber === 1 ? player1 : player2
    if (!myPlayer || myPlayer.gameOver) return
    
    const now = Date.now()
    let needSave = false
    
    if (e.key === 'ArrowLeft') {
        myPlayer.current.x--
        if (collision(myPlayer)) myPlayer.current.x++
        draw(myPlayer)
        needSave = true
    }
    if (e.key === 'ArrowRight') {
        myPlayer.current.x++
        if (collision(myPlayer)) myPlayer.current.x--
        draw(myPlayer)
        needSave = true
    }
    if (e.key === 'ArrowDown') {
        moveDown(myPlayer)
        draw(myPlayer)
        needSave = true
    }
    if (e.key === 'ArrowUp') {
        rotate(myPlayer)
        draw(myPlayer)
        needSave = true
    }
    if (e.key === ' ') {
        e.preventDefault()
        hardDrop(myPlayer)
        draw(myPlayer)
        needSave = true
    }
    
    // Ukl√°dej jen ka≈æd√Ωch 200ms
    if (needSave && now - lastControlSave > 200) {
        saveGameState(myPlayer)
        lastControlSave = now
    }
})

// Export funkc√≠ na window pro onclick atributy (HNED!)
window.createGame = createGame
window.showJoinMenu = showJoinMenu
window.joinGame = joinGame
window.cancelGame = cancelGame
window.backToMenu = backToMenu
window.leaveGame = leaveGame

// Inicializace
loadUser()
</script>
</body>
</html>


<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tetris Multiplayer</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    margin: 0;
    background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #0a0a0a 100%);
    font-family: "Segoe UI", sans-serif;
    color: white;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow-x: hidden;
}

.centered {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
}

h1 {
    margin-bottom: 30px;
    font-size: 56px;
    text-align: center;
    text-shadow: 0 0 20px #ff00ff, 0 0 40px #ff00ff;
    animation: glow 2s ease-in-out infinite;
}

@keyframes glow {
    0%, 100% { text-shadow: 0 0 20px #ff00ff, 0 0 40px #ff00ff; }
    50% { text-shadow: 0 0 30px #00ffff, 0 0 60px #00ffff; }
}

#backBtn {
    position: absolute;
    top: 20px;
    left: 20px;
    padding: 12px 24px;
    border-radius: 8px;
    border: 2px solid #ff00ff;
    background: rgba(180, 0, 180, 0.3);
    color: white;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 0 15px rgba(255, 0, 255, 0.5);
    z-index: 10;
    transition: all 0.3s;
}

#backBtn:hover {
    background: rgba(255, 0, 255, 0.5);
    box-shadow: 0 0 25px rgba(255, 0, 255, 0.8);
    transform: translateY(-2px);
}

button.menuBtn {
    padding: 16px 48px;
    margin: 12px 0;
    font-size: 22px;
    border: 2px solid #00ffff;
    border-radius: 12px;
    cursor: pointer;
    font-weight: bold;
    background: linear-gradient(135deg, rgba(0, 100, 200, 0.4), rgba(100, 0, 200, 0.4));
    color: white;
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
    transition: all 0.3s;
    min-width: 280px;
}

button.menuBtn:hover {
    transform: scale(1.08) translateY(-3px);
    box-shadow: 0 0 35px rgba(0, 255, 255, 0.8);
    background: linear-gradient(135deg, rgba(0, 150, 255, 0.6), rgba(150, 0, 255, 0.6));
}

.info-box {
    background: rgba(30, 30, 60, 0.7);
    border: 2px solid #00ffff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
    min-width: 180px;
}

.info-box h3 {
    text-align: center;
    margin-bottom: 15px;
    color: #00ffff;
    text-shadow: 0 0 10px #00ffff;
}

.score-display {
    font-size: 32px;
    font-weight: bold;
    text-align: center;
    color: #fff;
    text-shadow: 0 0 10px #ff00ff;
}

.cell {
    width: 25px;
    height: 25px;
    background: #1a1a2e;
    border: 1px solid #111;
    border-radius: 3px;
    transition: all 0.1s;
}

.cell.filled {
    box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.3);
}

#gameCodeDisplay {
    background: rgba(0,255,255,0.1);
    border: 3px solid #0ff;
    border-radius: 12px;
    padding: 30px;
    margin: 20px 0;
    text-align: center;
}

#gameCodeDisplay h2 {
    color: #0ff;
    font-size: 48px;
    margin-bottom: 20px;
}

#gameCodeText {
    font-size: 72px;
    font-weight: 900;
    color: #fff;
    text-shadow: 0 0 30px #0ff;
    letter-spacing: 10px;
}

#gameInput {
    padding: 15px;
    font-size: 18px;
    margin: 20px 0;
    width: 300px;
    text-align: center;
    text-transform: uppercase;
    background: rgba(0,0,0,0.5);
    color: #fff;
    border: 2px solid #0ff;
    border-radius: 8px;
}

#gameInput:focus {
    outline: none;
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
}

.game-arena {
    display: flex;
    gap: 40px;
    justify-content: center;
    align-items: flex-start;
    margin-top: 30px;
}

.player-section {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.player-name {
    font-size: 32px;
    font-weight: 900;
    margin-bottom: 20px;
    text-shadow: 0 0 20px currentColor;
}

.player-stats {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}

.tetris-grid {
    display: grid;
    gap: 1px;
    background: rgba(17, 17, 34, 0.9);
    border: 3px solid;
    border-radius: 8px;
    box-shadow: 0 0 40px;
    padding: 3px;
}

.status-text {
    font-size: 20px;
    font-weight: 900;
    margin-top: 15px;
    text-align: center;
}

.winner-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 100;
}

.winner-content {
    background: linear-gradient(135deg, #1a1a2e, #2a2a4e);
    padding: 60px;
    border-radius: 16px;
    border: 3px solid gold;
    box-shadow: 0 0 50px gold;
    text-align: center;
}

.winner-content h1 {
    font-size: 64px;
    color: gold;
    text-shadow: 0 0 30px gold;
    margin-bottom: 30px;
}

.controls {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(30, 30, 60, 0.8);
    border: 2px solid #00ffff;
    border-radius: 8px;
    padding: 15px;
    font-size: 14px;
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
}

.controls h4 {
    color: #00ffff;
    margin-bottom: 8px;
}

.controls div {
    margin: 4px 0;
}

@media (max-width: 1200px) {
    .game-arena {
        flex-direction: column;
        gap: 20px;
    }
}
</style>
</head>
<body>

<button id="backBtn">‚¨Ö Zpƒõt</button>

<div id="mainMenu" class="centered">
    <h1>üåê TETRIS MULTIPLAYER üåê</h1>
    <button class="menuBtn" id="createBtn">üéÆ Vytvo≈ôit hru</button>
    <button class="menuBtn" id="joinBtn">üîó P≈ôipojit se ke h≈ôe</button>
</div>

<div id="joinMenu" class="centered" style="display:none;">
    <h1>üîó P≈ôipojit se ke h≈ôe</h1>
    <input id="gameInput" placeholder="Zadej k√≥d hry (nap≈ô. ABC123)" maxlength="6">
    <button class="menuBtn" id="joinGameBtn">‚úÖ P≈ôipojit se</button>
    <button class="menuBtn" id="backFromJoinBtn">‚¨Ö Zpƒõt</button>
</div>

<div id="waitingRoom" class="centered" style="display:none;">
    <h1>‚è≥ ƒåek√°rna</h1>
    <div id="gameCodeDisplay">
        <h2>K√ìD HRY</h2>
        <div id="gameCodeText">------</div>
    </div>
    
    <div style="display: flex; gap: 40px; margin: 30px 0;">
        <div style="text-align: center; padding: 20px; background: rgba(0,255,255,0.1); border: 2px solid #0ff; border-radius: 12px; min-width: 200px;">
            <h3 style="color: #0ff; margin-bottom: 15px;">üéÆ HR√Åƒå 1</h3>
            <p id="player1WaitName" style="font-size: 24px; color: #fff; margin-bottom: 15px;">ƒåek√°...</p>
            <p id="player1Ready" style="font-size: 48px;">‚è≥</p>
        </div>
        
        <div style="text-align: center; padding: 20px; background: rgba(255,0,255,0.1); border: 2px solid #f0f; border-radius: 12px; min-width: 200px;">
            <h3 style="color: #f0f; margin-bottom: 15px;">üéÆ HR√Åƒå 2</h3>
            <p id="player2WaitName" style="font-size: 24px; color: #fff; margin-bottom: 15px;">ƒåek√°...</p>
            <p id="player2Ready" style="font-size: 48px;">‚è≥</p>
        </div>
    </div>
    
    <div id="countdownDisplay" style="display:none; font-size: 72px; color: #0ff; text-shadow: 0 0 30px #0ff; margin: 30px 0; font-weight: 900;">
        10
    </div>
    
    <button id="readyBtn" class="menuBtn" style="display:none;">‚úÖ READY!</button>
    <button id="startBtn" class="menuBtn" style="display:none;">üöÄ SPUSTIT HRU</button>
    <button class="menuBtn" id="cancelBtn">‚ùå Zru≈°it</button>
</div>

<div id="gameArena" style="display:none;">
    <div style="text-align: center; margin-bottom: 20px;">
        <h1>üåê ONLINE MULTIPLAYER</h1>
        <p style="font-size: 24px; color: #0ff;">K√≥d hry: <span id="currentGameCode">------</span></p>
    </div>
    
    <div class="game-arena">
        <div class="player-section">
            <div class="player-name" id="player1Name" style="color: #00ffff;">üéÆ HR√Åƒå 1</div>
            <div class="player-stats">
                <div class="info-box">
                    <h3>SK√ìRE</h3>
                    <div class="score-display" id="score1">0</div>
                </div>
                <div class="info-box">
                    <h3>√öROVE≈á</h3>
                    <div class="score-display" id="level1">1</div>
                </div>
            </div>
            <div id="grid1" class="tetris-grid" style="border-color: #00ffff; box-shadow: 0 0 40px rgba(0,255,255,0.5);"></div>
            <p class="status-text" id="status1" style="color: #0f0;">‚úÖ HRAJE</p>
        </div>
        
        <div class="player-section">
            <div class="player-name" id="player2Name" style="color: #ff00ff;">üéÆ HR√Åƒå 2</div>
            <div class="player-stats">
                <div class="info-box">
                    <h3>SK√ìRE</h3>
                    <div class="score-display" id="score2">0</div>
                </div>
                <div class="info-box">
                    <h3>√öROVE≈á</h3>
                    <div class="score-display" id="level2">1</div>
                </div>
            </div>
            <div id="grid2" class="tetris-grid" style="border-color: #ff00ff; box-shadow: 0 0 40px rgba(255,0,255,0.5);"></div>
            <p class="status-text" id="status2" style="color: #0f0;">‚úÖ HRAJE</p>
        </div>
    </div>
    
    <button class="menuBtn" id="leaveGameBtn" style="margin-top: 30px;">üö™ Zpƒõt do menu</button>
</div>

<div id="winnerOverlay" class="winner-overlay">
    <div class="winner-content">
        <h1>üèÜ V√çTƒöZ üèÜ</h1>
        <p id="winnerText" style="font-size: 48px; color: #fff; margin-bottom: 30px;">-</p>
        <button class="menuBtn" id="backToMenuBtn">üè† Zpƒõt do menu</button>
    </div>
</div>

<div class="controls">
    <h4>OVL√ÅD√ÅN√ç:</h4>
    <div>‚¨ÖÔ∏è‚û°Ô∏è - Pohyb</div>
    <div>‚¨ÜÔ∏è - Rotace</div>
    <div>‚¨áÔ∏è - Rychlej≈°√≠ p√°d</div>
    <div>MEZERN√çK - Okam≈æit√© um√≠stƒõn√≠</div>
</div>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.3';

const SUPABASE_URL = 'https://bmmaijlbpwgzhrxzxphf.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJtbWFpamxicHdnemhyeHp4cGhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NjQ5MDcsImV4cCI6MjA4MjQ0MDkwN30.s0YQVnAjMXFu1pSI1NXZ2naSab179N0vQPglsmy3Pgw';

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;
let currentGameId = null;
let currentGameCode = null;
let myPlayerNumber = null;
let gameActive = false;
let player1 = null;
let player2 = null;
let gameStateChannel = null;
let waitingChannel = null;
let player1IsReady = false;
let player2IsReady = false;

const themes = {
    classic: { cyan: '#00ffff', yellow: '#ffff00', purple: '#ff00ff', green: '#00ff00', red: '#ff0000', blue: '#0000ff', orange: '#ff8800' }
};

function getColorFromTheme(themeName, colorName) {
    const theme = themes[themeName] || themes.classic;
    return theme[colorName] || theme.cyan;
}

const shapes = [
    {shape: [[1,1,1,1]], color: 'cyan'},
    {shape: [[1,1],[1,1]], color: 'yellow'},
    {shape: [[0,1,0],[1,1,1]], color: 'purple'},
    {shape: [[0,1,1],[1,1,0]], color: 'green'},
    {shape: [[1,1,0],[0,1,1]], color: 'red'},
    {shape: [[1,0,0],[1,1,1]], color: 'blue'},
    {shape: [[0,0,1],[1,1,1]], color: 'orange'}
];

async function loadUserSettings() {
    return { rows: 20, cols: 10, theme: 'classic' };
}

async function loadUser() {
    const saved = localStorage.getItem('currentUser');
    if (saved) {
        try {
            currentUser = JSON.parse(saved);
        } catch (e) {
            currentUser = { username: saved, is_guest: true };
        }
    } else {
        currentUser = { username: 'Host_' + Math.floor(Math.random() * 10000), is_guest: true };
    }
}

function generateGameCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let code = '';
    for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
}

async function createGame() {
    const gameCode = generateGameCode();
    const settings = await loadUserSettings();
    
    try {
        const { data, error } = await supabase
            .from('tetris_multiplayer_games')
            .insert([{
                game_code: gameCode,
                player1_id: currentUser.id || null,
                player1_username: currentUser.username,
                player1_ready: false,
                player2_ready: false,
                player1_map_rows: settings.rows,
                player1_map_cols: settings.cols,
                player1_theme: settings.theme,
                status: 'waiting'
            }])
            .select()
            .single();
        
        if (error) throw error;
        
        currentGameId = data.id;
        currentGameCode = gameCode;
        myPlayerNumber = 1;
        
        document.getElementById('mainMenu').style.display = 'none';
        document.getElementById('waitingRoom').style.display = 'flex';
        document.getElementById('gameCodeText').textContent = gameCode;
        document.getElementById('player1WaitName').textContent = currentUser.username;
        
        waitForBothPlayers();
    } catch (error) {
        console.error('Chyba:', error);
        alert('Chyba p≈ôi vytv√°≈ôen√≠ hry!');
    }
}

function showJoinMenu() {
    document.getElementById('mainMenu').style.display = 'none';
    document.getElementById('joinMenu').style.display = 'flex';
}

async function joinGame() {
    const code = document.getElementById('gameInput').value.trim().toUpperCase();
    
    if (!code || code.length !== 6) {
        alert('Zadej platn√Ω 6-m√≠stn√Ω k√≥d hry!');
        return;
    }
    
    const settings = await loadUserSettings();
    
    try {
        const { data: game, error: fetchError } = await supabase
            .from('tetris_multiplayer_games')
            .select('*')
            .eq('game_code', code)
            .eq('status', 'waiting')
            .single();
        
        if (fetchError || !game) {
            alert('Hra s t√≠mto k√≥dem neexistuje!');
            return;
        }
        
        await supabase
            .from('tetris_multiplayer_games')
            .update({
                player2_id: currentUser.id || null,
                player2_username: currentUser.username,
                player2_map_rows: settings.rows,
                player2_map_cols: settings.cols,
                player2_theme: settings.theme
            })
            .eq('id', game.id);
        
        currentGameId = game.id;
        currentGameCode = code;
        myPlayerNumber = 2;
        
        document.getElementById('joinMenu').style.display = 'none';
        document.getElementById('waitingRoom').style.display = 'flex';
        document.getElementById('gameCodeText').textContent = code;
        document.getElementById('player1WaitName').textContent = game.player1_username;
        document.getElementById('player2WaitName').textContent = currentUser.username;
        document.getElementById('readyBtn').style.display = 'block';
        
        waitForBothPlayers();
    } catch (error) {
        console.error('Chyba:', error);
        alert('Chyba p≈ôi p≈ôipojov√°n√≠!');
    }
}

async function waitForBothPlayers() {
    console.log('ƒåek√°m v m√≠stnosti, player:', myPlayerNumber);
    
    // Pokud jsem hr√°ƒç 1, sleduj kdy p≈ôijde hr√°ƒç 2 a pak zobraz READY tlaƒç√≠tko
    if (myPlayerNumber === 1) {
        const checkInterval = setInterval(async () => {
            const { data: game } = await supabase
                .from('tetris_multiplayer_games')
                .select('*')
                .eq('id', currentGameId)
                .single();
            
            if (game && game.player2_username) {
                clearInterval(checkInterval);
                console.log('Hr√°ƒç 2 se p≈ôipojil:', game.player2_username);
                document.getElementById('player2WaitName').textContent = game.player2_username;
                // OPRAVA: Zobraz READY tlaƒç√≠tko i pro hr√°ƒçe 1!
                document.getElementById('readyBtn').style.display = 'block';
            }
        }, 1000);
        window.waitInterval = checkInterval;
    }
    
    // Sleduj ready stavy obou hr√°ƒç≈Ø a status hry
    waitingChannel = supabase
        .channel(`waiting_${currentGameId}`)
        .on('postgres_changes', {
            event: 'UPDATE',
            schema: 'public',
            table: 'tetris_multiplayer_games',
            filter: `id=eq.${currentGameId}`
        }, (payload) => {
            console.log('Zmƒõna stavu hry:', payload.new);
            
            // Pokud host spustil odpoƒç√≠t√°v√°n√≠
            // Pokud host spustil odpoƒç√≠t√°v√°n√≠
if (payload.new.status === 'countdown' && myPlayerNumber === 2) {
    document.getElementById('readyBtn').style.display = 'none';
    
    const countdownEl = document.getElementById('countdownDisplay');
    countdownEl.style.display = 'block';
    
    let count = 10;
    countdownEl.textContent = count;
    
    const interval = setInterval(() => {
        count--;
        if (count > 0) {
            countdownEl.textContent = count;
        } else {
            clearInterval(interval);
            countdownEl.textContent = 'START!';
        }
    }, 1000);
}

// Pokud se zaƒçalo hr√°t
if (payload.new.status === 'playing') {
    setTimeout(() => {
        startGame();
    }, 500);
}
            
            updateReadyStatus(payload.new);
        })
        .subscribe();
    
    // Naƒçti aktu√°ln√≠ stav
    const { data: game } = await supabase
        .from('tetris_multiplayer_games')
        .select('*')
        .eq('id', currentGameId)
        .single();
    
    if (game) {
        updateReadyStatus(game);
        // Pokud u≈æ je hr√°ƒç 2 p≈ôipojen√Ω a jsem host, zobraz READY
        if (myPlayerNumber === 1 && game.player2_username) {
            document.getElementById('readyBtn').style.display = 'block';
        }
    }
}

function updateReadyStatus(game) {
    player1IsReady = game.player1_ready || false;
    player2IsReady = game.player2_ready || false;
    
    console.log('Ready status - P1:', player1IsReady, 'P2:', player2IsReady, 'MyPlayer:', myPlayerNumber);
    
    document.getElementById('player1Ready').textContent = player1IsReady ? '‚úÖ' : '‚è≥';
    document.getElementById('player2Ready').textContent = player2IsReady ? '‚úÖ' : '‚è≥';
    
    if (game.player2_username) {
        document.getElementById('player2WaitName').textContent = game.player2_username;
    }
    
    // Pokud jsou oba ready, zobraz tlaƒç√≠tko START hostu (hr√°ƒç 1)
    if (player1IsReady && player2IsReady) {
        console.log('Oba jsou ready!');
        if (myPlayerNumber === 1) {
            console.log('Zobrazuji tlaƒç√≠tko START pro hosta');
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('readyBtn').style.display = 'none';
        } else {
            console.log('Hr√°ƒç 2 ƒçek√° na spu≈°tƒõn√≠');
            document.getElementById('readyBtn').style.display = 'none';
        }
    }
}

async function setReady() {
    const field = myPlayerNumber === 1 ? 'player1_ready' : 'player2_ready';
    
    console.log('Nastavuji ready pro:', field);
    
    const { data, error } = await supabase
        .from('tetris_multiplayer_games')
        .update({ [field]: true })
        .eq('id', currentGameId)
        .select()
        .single();
    
    if (error) {
        console.error('Chyba p≈ôi nastaven√≠ ready:', error);
    } else {
        console.log('Ready nastaveno √∫spƒõ≈°nƒõ:', data);
    }
    
    document.getElementById('readyBtn').style.display = 'none';
    
    // Naƒçti aktu√°ln√≠ stav a updatuj UI
    const { data: game } = await supabase
        .from('tetris_multiplayer_games')
        .select('*')
        .eq('id', currentGameId)
        .single();
    
    if (game) {
        updateReadyStatus(game);
    }
}

async function startCountdown() {
    await supabase
        .from('tetris_multiplayer_games')
        .update({ status: 'countdown' })
        .eq('id', currentGameId);
    
    document.getElementById('startBtn').style.display = 'none';
    document.getElementById('readyBtn').style.display = 'none';
    
    const countdownEl = document.getElementById('countdownDisplay');
    countdownEl.style.display = 'block';
    
    let count = 10;
    countdownEl.textContent = count;
    
    const interval = setInterval(async () => {
        count--;
        if (count > 0) {
            countdownEl.textContent = count;
        } else {
            clearInterval(interval);
            countdownEl.textContent = 'START!';
            
            await supabase
                .from('tetris_multiplayer_games')
                .update({ status: 'playing' })
                .eq('id', currentGameId);
            
            setTimeout(() => {
                startGame();
            }, 500);
        }
    }, 1000);
}

async function cancelGame() {
    if (window.waitInterval) {
        clearInterval(window.waitInterval);
    }
    
    if (waitingChannel) {
        await waitingChannel.unsubscribe();
    }
    
    if (currentGameId) {
        await supabase
            .from('tetris_multiplayer_games')
            .delete()
            .eq('id', currentGameId);
    }
    
    backToMenu();
}

function backToMenu() {
    if (gameStateChannel) {
        gameStateChannel.unsubscribe();
    }
    
    gameActive = false;
    currentGameId = null;
    
    document.getElementById('mainMenu').style.display = 'flex';
    document.getElementById('joinMenu').style.display = 'none';
    document.getElementById('waitingRoom').style.display = 'none';
    document.getElementById('gameArena').style.display = 'none';
    document.getElementById('winnerOverlay').style.display = 'none';
}

async function startGame() {
    if (window.waitInterval) {
        clearInterval(window.waitInterval);
    }
    
    document.getElementById('waitingRoom').style.display = 'none';
    document.getElementById('gameArena').style.display = 'flex';
    document.getElementById('currentGameCode').textContent = currentGameCode;
    
    gameActive = true;
    
    const { data: game } = await supabase
        .from('tetris_multiplayer_games')
        .select('*')
        .eq('id', currentGameId)
        .single();
    
    document.getElementById('player1Name').textContent = `üéÆ ${game.player1_username}`;
    document.getElementById('player2Name').textContent = `üéÆ ${game.player2_username}`;
    
    player1 = createPlayer('grid1', 'score1', 'level1', 1, 20, 10, 'classic');
    player2 = createPlayer('grid2', 'score2', 'level2', 2, 20, 10, 'classic');
    
    const myPlayer = myPlayerNumber === 1 ? player1 : player2;
    await saveGameState(myPlayer);
    
    subscribeToGame();
    gameLoop();
}

function createPlayer(gridId, scoreId, levelId, playerNum, rows, cols, themeName) {
    const player = {
        grid: [],
        current: null,
        nextPiece: null,
        score: 0,
        level: 1,
        lines: 0,
        gameOver: false,
        dropInterval: 600,
        lastDrop: Date.now(),
        gridElement: document.getElementById(gridId),
        scoreElement: document.getElementById(scoreId),
        levelElement: document.getElementById(levelId),
        rows: rows,
        cols: cols,
        playerNumber: playerNum,
        theme: themeName
    };
    
    player.gridElement.innerHTML = '';
    player.gridElement.style.gridTemplateRows = `repeat(${rows}, 25px)`;
    player.gridElement.style.gridTemplateColumns = `repeat(${cols}, 25px)`;
    
    for (let r = 0; r < rows; r++) {
        player.grid[r] = [];
        for (let c = 0; c < cols; c++) {
            const cell = document.createElement('div');
            cell.classList.add('cell');
            player.gridElement.appendChild(cell);
            player.grid[r][c] = 0;
        }
    }
    
    player.nextPiece = randomShape();
    newPiece(player);
    
    return player;
}

function randomShape() {
    const shape = shapes[Math.floor(Math.random() * shapes.length)];
    return {
        shape: shape.shape.map(r => r.slice()),
        color: shape.color
    };
}

function newPiece(player) {
    player.current = player.nextPiece;
    player.current.x = Math.floor(player.cols / 2) - 1;
    player.current.y = 0;
    player.nextPiece = randomShape();
    
    if (collision(player)) {
        player.gameOver = true;
        const winnerNumber = player.playerNumber === 1 ? 2 : 1;
        endGame(winnerNumber);
    }
}

function collision(player, offsetX = 0, offsetY = 0) {
    for (let r = 0; r < player.current.shape.length; r++) {
        for (let c = 0; c < player.current.shape[r].length; c++) {
            if (player.current.shape[r][c]) {
                let newY = player.current.y + r + offsetY;
                let newX = player.current.x + c + offsetX;
                if (newY >= player.rows || newX < 0 || newX >= player.cols) return true;
                if (newY >= 0 && player.grid[newY][newX]) return true;
            }
        }
    }
    return false;
}

function moveDown(player) {
    if (player.gameOver) return;
    player.current.y++;
    if (collision(player)) {
        player.current.y--;
        freeze(player);
        newPiece(player);
    }
}

function freeze(player) {
    for (let r = 0; r < player.current.shape.length; r++) {
        for (let c = 0; c < player.current.shape[r].length; c++) {
            if (player.current.shape[r][c]) {
                player.grid[player.current.y + r][player.current.x + c] = player.current.color;
            }
        }
    }
    clearLines(player);
}

function clearLines(player) {
    let cleared = 0;
    for (let r = player.rows - 1; r >= 0; r--) {
        if (player.grid[r].every(cell => cell !== 0)) {
            player.grid.splice(r, 1);
            player.grid.unshift(Array(player.cols).fill(0));
            cleared++;
            r++;
        }
    }
    
    if (cleared > 0) {
        player.lines += cleared;
        player.score += cleared * 100 * player.level;
        player.level = Math.floor(player.lines / 10) + 1;
        player.dropInterval = Math.max(100, 600 - (player.level * 50));
        updateDisplay(player);
    }
}

function draw(player) {
    const cells = player.gridElement.querySelectorAll('.cell');
    
    cells.forEach(cell => {
        cell.style.background = '#1a1a2e';
        cell.style.boxShadow = 'none';
        cell.classList.remove('filled');
    });
    
    for (let r = 0; r < player.rows; r++) {
        for (let c = 0; c < player.cols; c++) {
            if (player.grid[r][c]) {
                const cell = cells[r * player.cols + c];
                const color = getColorFromTheme(player.theme, player.grid[r][c]);
                cell.style.background = color;
                cell.style.boxShadow = `0 0 8px ${color}`;
                cell.classList.add('filled');
            }
        }
    }
    
    if (player.current) {
        for (let r = 0; r < player.current.shape.length; r++) {
            for (let c = 0; c < player.current.shape[r].length; c++) {
                if (player.current.shape[r][c]) {
                    const index = (player.current.y + r) * player.cols + (player.current.x + c);
                    if (index >= 0 && index < cells.length) {
                        const color = getColorFromTheme(player.theme, player.current.color);
                        cells[index].style.background = color;
                        cells[index].style.boxShadow = `0 0 12px ${color}`;
                        cells[index].classList.add('filled');
                    }
                }
            }
        }
    }
}

function updateDisplay(player) {
    player.scoreElement.textContent = player.score;
    player.levelElement.textContent = player.level;
}

function rotate(player) {
    const shape = player.current.shape;
    const N = shape.length;
    const M = shape[0].length;
    const rotated = [];
    
    for (let y = 0; y < M; y++) {
        rotated[y] = [];
        for (let x = 0; x < N; x++) {
            rotated[y][x] = shape[N - 1 - x][y] || 0;
        }
    }
    
    const oldShape = player.current.shape;
    player.current.shape = rotated;
    
    if (collision(player)) {
        player.current.shape = oldShape;
    }
}

function hardDrop(player) {
    while (!collision(player, 0, 1)) {
        player.current.y++;
    }
    freeze(player);
    newPiece(player);
    player.score += 10;
    updateDisplay(player);
}

async function saveGameState(player) {
    if (!currentGameId || !player) return;
    
    try {
        await supabase.from('tetris_game_state').delete().eq('game_id', currentGameId).eq('player_number', player.playerNumber);
        
        await supabase.from('tetris_game_state').insert({
            game_id: currentGameId,
            player_number: player.playerNumber,
            grid: JSON.stringify(player.grid),
            current_piece: JSON.stringify(player.current),
            score: player.score,
            level: player.level,
            lines: player.lines,
            game_over: player.gameOver,
            updated_at: new Date().toISOString()
        });
    } catch (error) {
        console.error('Chyba:', error);
    }
}

function subscribeToGame() {
    gameStateChannel = supabase.channel(`game_state_${currentGameId}`)
        .on('postgres_changes', {
            event: '*',
            schema: 'public',
            table: 'tetris_game_state',
            filter: `game_id=eq.${currentGameId}`
        }, async (payload) => {
            if (payload.new.player_number !== myPlayerNumber) {
                const otherPlayer = payload.new.player_number === 1 ? player1 : player2;
                
                try {
                    otherPlayer.grid = JSON.parse(payload.new.grid);
                    otherPlayer.current = JSON.parse(payload.new.current_piece);
                } catch (e) {
                    otherPlayer.grid = payload.new.grid;
                    otherPlayer.current = payload.new.current_piece;
                }
                
                otherPlayer.score = payload.new.score;
                otherPlayer.level = payload.new.level;
                otherPlayer.gameOver = payload.new.game_over;
                
                updateDisplay(otherPlayer);
                draw(otherPlayer);
                
                if (payload.new.game_over) {
                    document.getElementById(`status${payload.new.player_number}`).textContent = '‚ùå PROHR√ÅL';
                    document.getElementById(`status${payload.new.player_number}`).style.color = '#f00';
                }
            }
        }).subscribe();
}

async function endGame(winnerNumber) {
    gameActive = false;
    
    const { data: game } = await supabase.from('tetris_multiplayer_games').select('*').eq('id', currentGameId).single();
    
    const winner = winnerNumber === 1 ? game.player1_username : game.player2_username;
    
    await supabase.from('tetris_multiplayer_games').update({ status: 'finished', winner: winner }).eq('id', currentGameId);
    
    const iWon = winnerNumber === myPlayerNumber;
    
    document.getElementById('winnerText').textContent = iWon ? 'üéâ VYHR√ÅL JSI! +100 üí∞' : `üò¢ ${winner} vyhr√°l!`;
    document.getElementById('winnerOverlay').style.display = 'flex';
}

function gameLoop() {
    if (!gameActive) return;
    
    const now = Date.now();
    const myPlayer = myPlayerNumber === 1 ? player1 : player2;
    const otherPlayer = myPlayerNumber === 1 ? player2 : player1;
    
    if (!myPlayer.gameOver && now - myPlayer.lastDrop > myPlayer.dropInterval) {
        moveDown(myPlayer);
        draw(myPlayer);
        myPlayer.lastDrop = now;
        saveGameState(myPlayer);
    }
    
    draw(otherPlayer);
    requestAnimationFrame(gameLoop);
}

document.addEventListener('keydown', e => {
    if (!gameActive) return;
    const myPlayer = myPlayerNumber === 1 ? player1 : player2;
    if (!myPlayer || myPlayer.gameOver) return;
    
    if (e.key === 'ArrowLeft') {
        myPlayer.current.x--;
        if (collision(myPlayer)) myPlayer.current.x++;
        draw(myPlayer);
        saveGameState(myPlayer);
    }
    if (e.key === 'ArrowRight') {
        myPlayer.current.x++;
        if (collision(myPlayer)) myPlayer.current.x--;
        draw(myPlayer);
        saveGameState(myPlayer);
    }
    if (e.key === 'ArrowDown') {
        moveDown(myPlayer);
        draw(myPlayer);
        saveGameState(myPlayer);
    }
    if (e.key === 'ArrowUp') {
        rotate(myPlayer);
        draw(myPlayer);
        saveGameState(myPlayer);
    }
    if (e.key === ' ') {
        e.preventDefault();
        hardDrop(myPlayer);
        draw(myPlayer);
        saveGameState(myPlayer);
    }
});

document.getElementById('createBtn').addEventListener('click', createGame);
document.getElementById('joinBtn').addEventListener('click', showJoinMenu);
document.getElementById('joinGameBtn').addEventListener('click', joinGame);
document.getElementById('backFromJoinBtn').addEventListener('click', backToMenu);
document.getElementById('readyBtn').addEventListener('click', setReady);
document.getElementById('startBtn').addEventListener('click', startCountdown);
document.getElementById('cancelBtn').addEventListener('click', cancelGame);
document.getElementById('backBtn').addEventListener('click', () => window.location.href = 'hry.html');
document.getElementById('leaveGameBtn').addEventListener('click', () => window.location.href = 'hry.html');
document.getElementById('backToMenuBtn').addEventListener('click', backToMenu);

loadUser();
</script>
</body>
</html>

